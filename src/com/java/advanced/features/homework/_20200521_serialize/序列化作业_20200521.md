# 1. 阅读ObjectOutputStream源码，弄懂writeObject的流程

数据类使用 Person2.java:

```java
public class Person2 implements Serializable {
    private static final long serialVersionUID = 1L;
    private String name;
    private int age;
    public Person2(String name, int age) {
        this.name = name;
        this.age = age;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public int getAge() {
        return age;
    }
    public void setAge(int age) {
        this.age = age;
    }
}
```

测试代码：

```java
public class SerializableTest {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        String filePath = "./obj.object";
        FileOutputStream fos = new FileOutputStream(filePath);
        ObjectOutputStream oos = new ObjectOutputStream(fos);
        oos.writeObject(new Person2("wzc", 32));
        oos.close();
    }
}
```

运行程序，得到 obj.object 文件，使用 NotePad++打开， Hex Editor 插件查看对应的二进制文件：

![](obj.png)

跟踪源码：

#### 在构造 `ObjectOutputStream` 时，会调用 `writeStreamHeader()` 写入 aced 以及 0005。

调用 `writeObject()` 方法：

```java
public final void writeObject(Object obj) throws IOException {
    if (enableOverride) { // 这个值在构造方法方法中被初始化为false
        writeObjectOverride(obj);
        return;
    }
    try {
        writeObject0(obj, false); // => 代码走这里
    } catch (IOException ex) {
        if (depth == 0) {
            writeFatalException(ex);
        }
        throw ex;
    }
}
```

#### 调用 `writeObject0()` 方法，它是 `writeObject()` 方法的下层实现：

```java
private void writeObject0(Object obj, boolean unshared)
    throws IOException
{
    boolean oldMode = bout.setBlockDataMode(false);
    depth++;
    try {
        // handle previously written and non-replaceable objects
        // check for replacement object
        // if object replaced, run through original checks a second time
       	// 省略掉本次流程无关的代码，因为对象之前没有写过也没有没有发生替换。
        ObjectStreamClass desc = desc = ObjectStreamClass.lookup(cl, true);
        // remaining cases
        // obj 是 Person2 对象，它实现了 Serializable 接口，所以会进入 obj instanceof Serializable 分支
        if (obj instanceof String) {
            writeString((String) obj, unshared);
        } else if (cl.isArray()) {
            writeArray(obj, desc, unshared);
        } else if (obj instanceof Enum) {
            writeEnum((Enum<?>) obj, desc, unshared);
        } else if (obj instanceof Serializable) { 
            writeOrdinaryObject(obj, desc, unshared); // => 代码走这里
        } else {
            if (extendedDebugInfo) {
                throw new NotSerializableException(
                    cl.getName() + "\n" + debugInfoStack.toString());
            } else {
                throw new NotSerializableException(cl.getName());
            }
        }
    } finally {
        depth--;
        bout.setBlockDataMode(oldMode);
    }
}
```

#### 调用 `writeOrdinaryObject()` 方法，这个方法的作用是把普通的序列化对象的表现写入到流中：

```java
private void writeOrdinaryObject(Object obj,
                                 ObjectStreamClass desc,
                                 boolean unshared)
    throws IOException
{
    try {
        desc.checkSerialize();
        bout.writeByte(TC_OBJECT);// 表示写入新的对象
        writeClassDesc(desc, false);
        handles.assign(unshared ? null : obj);
        // Person2 没有实现 Externalizable 接口，所以走 else 分支
        if (desc.isExternalizable() && !desc.isProxy()) {
            writeExternalData((Externalizable) obj);
        } else {
            writeSerialData(obj, desc); // => 代码走这里
        }
    } finally {
        if (extendedDebugInfo) {
            debugInfoStack.pop();
        }
    }
}
```

#### 调用 `writeSerialData()` 方法：

```java
private void writeSerialData(Object obj, ObjectStreamClass desc)
    throws IOException
{
    ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout(); // slots 长度为 1
    for (int i = 0; i < slots.length; i++) {
        ObjectStreamClass slotDesc = slots[i].desc;
        // Person2 没有声明 writeObject() 方法，所以 slotDesc.hasWriteObjectMethod() 是 false
        if (slotDesc.hasWriteObjectMethod()) {
           // 省略无关代码
        } else {
            defaultWriteFields(obj, slotDesc); // => 代码走这里
        }
    }
}
```

#### 调用 `defaultWriteFields()` 方法，这个方法的作用是获取给定对象序列化字段的值，并把值写入到流中：

```java
private void defaultWriteFields(Object obj, ObjectStreamClass desc)
    throws IOException
{
    Class<?> cl = desc.forClass();
    if (cl != null && obj != null && !cl.isInstance(obj)) {
        throw new ClassCastException();
    }
    desc.checkDefaultSerialize();
    int primDataSize = desc.getPrimDataSize(); // 获取对象中原始类型字段的累加字节数，这里只有一个 int age，所以是 4。
    if (primVals == null || primVals.length < primDataSize) {
        primVals = new byte[primDataSize]; // 创建容器参数
    }
    desc.getPrimFieldValues(obj, primVals); // 把 age 字段的值 32 写入到 primVals 这个容器参数里
    bout.write(primVals, 0, primDataSize, false); // 把 age 值写入到流中。
    ObjectStreamField[] fields = desc.getFields(false);
    Object[] objVals = new Object[desc.getNumObjFields()]; // 获取对象字段的数组，长度是 1
    int numPrimFields = fields.length - objVals.length; // 原始类型字段的个数，这里是 1
    desc.getObjFieldValues(obj, objVals);
    for (int i = 0; i < objVals.length; i++) {
        try {
            writeObject0(objVals[i],
                         fields[numPrimFields + i].isUnshared()); // => 代码走这里
        } finally {
            if (extendedDebugInfo) {
                debugInfoStack.pop();
            }
        }
    }
}
```

#### 调用 `writeObject0(Object obj, boolean unshared)` 方法，obj 的值就是 "wzc" 这个字符串：

```java
private void writeObject0(Object obj, boolean unshared)
    throws IOException
{
    boolean oldMode = bout.setBlockDataMode(false);
    depth++;
    try {
        // handle previously written and non-replaceable objects
        // check for replacement object
        // if object replaced, run through original checks a second time
       	// 省略掉本次流程无关的代码，因为对象之前没有写过也没有没有发生替换。
        ObjectStreamClass desc = desc = ObjectStreamClass.lookup(cl, true);
        // remaining cases
        // obj 是 String 对象，所以会进入 obj instanceof String 分支
        if (obj instanceof String) {
            writeString((String) obj, unshared); // => 代码走这里
        } else if (cl.isArray()) {
            writeArray(obj, desc, unshared);
        } else if (obj instanceof Enum) {
            writeEnum((Enum<?>) obj, desc, unshared);
        } else if (obj instanceof Serializable) { 
            writeOrdinaryObject(obj, desc, unshared); 
        } else {
            if (extendedDebugInfo) {
                throw new NotSerializableException(
                    cl.getName() + "\n" + debugInfoStack.toString());
            } else {
                throw new NotSerializableException(cl.getName());
            }
        }
    } finally {
        depth--;
        bout.setBlockDataMode(oldMode);
    }
}
```

#### `writeString()` 方法，把字符串写入流中：

```java
private void writeString(String str, boolean unshared) throws IOException {
    handles.assign(unshared ? null : str);
    long utflen = bout.getUTFLength(str);
    if (utflen <= 0xFFFF) {
        bout.writeByte(TC_STRING);
        bout.writeUTF(str, utflen);
    } else {
        bout.writeByte(TC_LONGSTRING);
        bout.writeLongUTF(str, utflen);
    }
}
```



# 2. 自己写demo重现Serializable的细节问题